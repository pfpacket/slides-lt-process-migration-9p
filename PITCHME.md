
## Linux + process migration = 何
静大情報LT大会 -2017年10月-

---

## 自己紹介
* 棟方 亮 (IT悟空 @pf_packet) 
* 情報社会学科1年 ITS
* 趣味: Arch Linux, Rust, Wayland, Plan 9, 9p
* 前回は、「9pを用いたUserspace filesystem」という題で発表
* kernel panic, compile, module楽しい!

---

# ところで

---

## プロセスマイグレーションってご存知?

---

## プロセスマイグレーション
プロセスを、ある環境から、他の環境へ移動すること。

特殊なプロセス管理とも言える。

_**ここでは、ネットワーク越しに、プロセスをあるホストから、別のリモートホストに移動することに焦点を置く。**_

+++

### プロセスマイグレーション
#### プロセスを別ホストに投げられると何が嬉しいか
* 分散システムでは、あらゆる資源(CPU, 主記憶, 補助記憶, 周辺機器)を共有できる。
* 巨大な分散システムに、接続する端末は、非力なものを想定している。

なら、計算資源を要する処理は、高速な計算機に任せて、結果だけ利用者に返せば良い。

_**分散システムの計算資源の共有を実現できる。**

+++

## プロセスマイグレーション
プロセスをダンプして、プロセスのイメージデータを生成し、これを他のホストに送信し、リストアする。

+++

**そんなことできるんですか?**

+++

**できるんです。そうCRIUならね!**

---

## [CRIU](https://criu.org/Main_Page)
### Checkpoint/Restore In Userspace

![CRIU](assets/criu_logo.jpg)

+++

## [CRIU](https://criu.org/Main_Page)
### Checkpoint/Restore In Userspace

```
# CRIUでPID 15798をダンプして、~/tmp/criu_dump/15798 に
sudo criu dump --images-dir ~/tmp/criu_dump/15798 --leave-stopped --tree 15798

# 何らかの方法でリモートに送信

# CRIUでディスクに保存されたプロセスを復帰させる
sudo criu restore --tree 15798 --images-dir ~/tmp/criu_dump/15798/ --shell-job
```

PID namespaceを切ってやるとPID衝突が起こらない!

---

## そんなに甘くは無い!
* open file
* network stack (state)
* 上記にちなんで、socket
* 周辺機器の状態
* 通信先のプロセス等

---

## 具体的問題
* open fileはネットワークファイルシステムでマウント
* network stack(tcp connection等)はCRIUがなんとか
* 周辺機器: ムリ
* 通信先のプロセス: もっとムリ

---

## どうすんの?
CRIUではプロセスのファイルディスクリプタの状態自体はダンプされるので、マイグレーション後にそのファイルパスにアクセスできれば良い。(しかし、ファイルシーク位置が矛盾する可能性があるので、同一ファイルが好ましい)

9pでユーザースペースファイルシステムが実現(=ファイルサーバ)

だから、全てファイルで表現すれば解決。
すべての計算資源をファイルで。

+++

## なぜ解決できるのか?
* CRIUは、ファイルディスクリプターの全ての状態をcheckpoint/restoreできる。
* そのファイルを提供するファイルサーバーが、そのファイルが表現するサービスの状態を保持

_**事実上ファイルを通したIPC**_

_**マイグレーション前のファイルシステムを後のホストにマウントすればすべての資源をそのまま使い続けられる**_

---

## 進捗
* サーバー側9p  
rust-9pを実装、ユーザースペースファイルシステムが実現
* ネットワークを表現するファイルシステム  
fuse_planetfsでこれを実装
* Checkpoint/Restore  
CRIUで実現

**後は、どんどんサービスや資源をファイルシステムにマッピングするだけ**
